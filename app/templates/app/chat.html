{% extends 'app/base.html' %}
{% load static %}

{% block main-content %}
<div class="container py-4">
  <div class="chat-container mx-auto shadow rounded" style="max-width: 650px;">
    
    <!-- Header -->
    <div class="chat-header bg-success text-white p-3 rounded-top d-flex justify-content-between align-items-center">
      <h5 class="mb-0">GoGreen Bot üåø</h5>
      <small>{{ request.user.username }}</small>
    </div>

    <!-- Chat body -->
    <div class="chat-body p-3" id="chatBox">
      {% for msg in messages %}
        {% if msg.is_from_bot %}
          <!-- Tin nh·∫Øn bot -->
          <div class="d-flex align-items-start mb-3">
            <img src="{% static 'app/images/logo.jpg' %}" alt="Bot" class="chat-avatar me-2">
            <div class="chat-bubble bot-msg">
              {{ msg.content|safe }}
            </div>
          </div>
        {% else %}
          <!-- Tin nh·∫Øn ng∆∞·ªùi d√πng -->
          <div class="d-flex justify-content-end align-items-start mb-3">
            <div class="chat-bubble user-msg">
              {{ msg.content }}
            </div>
            {% if user.avatar %}
              <img src="{{ user.avatar.url }}" alt="User" class="chat-avatar ms-2">
            {% else %}
              <img src="{% static 'app/images/default-avatar.png' %}" alt="User" class="chat-avatar ms-2">
            {% endif %}
          </div>
        {% endif %}
      {% endfor %}
    </div>

    <!-- G·ª£i √Ω c√¢u h·ªèi -->
    <div class="chat-suggestions border-top p-2 bg-light text-center">
      {% for s in suggestions %}
        <button class="btn btn-outline-success btn-sm suggestion-btn m-1">{{ s }}</button>
      {% endfor %}
    </div>

    <!-- √î nh·∫≠p -->
    <form id="chatForm" method="POST" class="p-3 border-top d-flex align-items-center">
      {% csrf_token %}
      <input type="text" id="messageInput" name="message" class="form-control me-2" placeholder="Nh·∫≠p tin nh·∫Øn..." required>
      <button type="submit" class="btn btn-success">G·ª≠i</button>
    </form>
  </div>
</div>

<!-- Script -->
<script>
document.querySelectorAll('.suggestion-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelector('#messageInput').value = btn.textContent;
  });
});

document.getElementById('chatForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const input = document.getElementById('messageInput');
  const msg = input.value.trim();
  if (!msg) return;

  const chatBox = document.getElementById('chatBox');

  // Hi·ªÉn th·ªã tin ng∆∞·ªùi d√πng
  chatBox.innerHTML += `
    <div class="d-flex justify-content-end align-items-start mb-3">
      <div class="chat-bubble user-msg">${msg}</div>
      <img src="{% if user.avatar %}{{ user.avatar.url }}{% else %}{% static 'app/images/default-avatar.png' %}{% endif %}" 
           class="chat-avatar ms-2" alt="User">
    </div>
  `;
  chatBox.scrollTop = chatBox.scrollHeight;
  input.value = "";

  // Hi·ªáu ·ª©ng "bot ƒëang g√µ..."
  const typing = document.createElement('div');
  typing.classList.add('d-flex', 'align-items-start', 'mb-3');
  typing.innerHTML = `
    <img src="{% static 'app/images/bot-avatar.png' %}" alt="Bot" class="chat-avatar me-2">
    <div class="chat-bubble bot-msg"><i>GoGreen Bot ƒëang ph·∫£n h·ªìi...</i></div>
  `;
  chatBox.appendChild(typing);
  chatBox.scrollTop = chatBox.scrollHeight;

  // G·ª≠i request
  const response = await fetch("", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: `message=${encodeURIComponent(msg)}`
  });

  const data = await response.json();
  typing.remove(); // x√≥a hi·ªáu ·ª©ng typing

  // Hi·ªÉn th·ªã ph·∫£n h·ªìi bot
  chatBox.innerHTML += `
    <div class="d-flex align-items-start mb-3">
      <img src="{% static 'app/images/logo.jpg' %}" alt="Bot" class="chat-avatar me-2">
      <div class="chat-bubble bot-msg">${data.response}</div>
    </div>
  `;
  chatBox.scrollTop = chatBox.scrollHeight;
});
</script>

<!-- CSS -->
<style>
.chat-container {
  background: #fff;
  border-radius: 15px;
  overflow: hidden;
}
.chat-body {
  height: 450px;
  overflow-y: auto;
  background: #f8fff8;
}
.chat-avatar {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  object-fit: cover;
}
.chat-bubble {
  padding: 10px 15px;
  border-radius: 15px;
  max-width: 75%;
  word-wrap: break-word;
}
.bot-msg {
  background: #eafbe7;
  border: 1px solid #b5e48c;
}
.user-msg {
  background: #198754;
  color: white;
  border: 1px solid #157347;
}
.chat-suggestions button {
  border-radius: 20px;
  font-size: 0.85rem;
}
.chat-header h5 {
  font-weight: bold;
}
.chat-body::-webkit-scrollbar {
  width: 6px;
}
.chat-body::-webkit-scrollbar-thumb {
  background-color: #a8d5a2;
  border-radius: 5px;
}
</style>
{% endblock %}
