{% extends 'app/base.html' %}
{% load static %}

{% block main-content %}
<div class="container py-3" style="max-width: 800px; position: relative;">

  <!-- ğŸ”™ NÃšT QUAY Láº I -->
  <a href="javascript:history.back()" class="btn-back d-flex align-items-center justify-content-center">
    <i class="bi bi-arrow-left me-2"></i> <span class="fw-semibold">Quay láº¡i</span>
  </a>

  <!-- ğŸ–¼ áº¢NH Sá»° KIá»†N -->
  <div class="text-center mb-4 mt-3">
    {% if event.event_images.all %}
      <div id="eventCarousel" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner rounded-4 shadow-sm overflow-hidden">
          {% for img in event.event_images.all %}
            <div class="carousel-item {% if forloop.first %}active{% endif %}">
              <img src="{{ img.image.url }}" class="d-block w-100 event-banner" alt="áº¢nh sá»± kiá»‡n">
            </div>
          {% endfor %}
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#eventCarousel" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">TrÆ°á»›c</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#eventCarousel" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Sau</span>
        </button>
      </div>
    {% else %}
      <img src="{% static 'app/images/logo.jpg' %}" class="event-banner" alt="Logo sá»± kiá»‡n">
    {% endif %}
  </div>

  <!-- ğŸ§¾ THÃ”NG TIN Sá»° KIá»†N -->
  <div class="text-center mb-4">
    <h3 class="fw-bold text-success">{{ event.title }}</h3>
    <p class="text-muted mb-1">
      <i class="bi bi-geo-alt-fill"></i> {{ event.address|default:"Äang cáº­p nháº­t" }}
    </p>
    <div class="d-flex justify-content-center align-items-center gap-3">
      <span class="fs-5 fw-semibold text-success">ğŸŒ¿ {{ event.points|default:0 }} Ä‘iá»ƒm</span>
      <span class="text-muted small">| ğŸ‘¥ {{ event.participants_current }}/{{ event.participants_max }} ngÆ°á»i</span>
    </div>

    <!-- Tráº¡ng thÃ¡i -->
    <div class="mt-3">
      {% if event.status == "upcoming" %}
        <span class="badge bg-warning text-dark fs-6 px-3 py-2">ğŸŸ¡ Sáº¯p diá»…n ra</span>
      {% elif event.status == "in_progress" %}
        <span class="badge bg-success fs-6 px-3 py-2">ğŸŸ¢ Äang diá»…n ra</span>
      {% elif event.status == "done" %}
        <span class="badge bg-secondary fs-6 px-3 py-2">âš« ÄÃ£ káº¿t thÃºc</span>
      {% endif %}
    </div>

    {% if event.status == "upcoming" %}
      <div id="countdown" class="text-success mt-3 fs-5 fw-semibold"></div>
    {% endif %}
  </div>

  <!-- ğŸ§© MÃ” Táº¢ -->
  <div class="card shadow-sm border-0 p-4 mb-4 rounded-4">
    <h5 class="fw-bold mb-3 text-success">ğŸ§¾ ThÃ´ng tin chi tiáº¿t</h5>
    <p class="lh-lg" style="white-space: pre-line;">{{ event.details|default:"ChÆ°a cÃ³ mÃ´ táº£ chi tiáº¿t." }}</p>
  </div>

  <!-- â° THá»œI GIAN -->
  <div class="card shadow-sm border-0 p-4 mb-4 rounded-4">
    <h5 class="fw-bold mb-3 text-success">ğŸ•’ Thá»i gian diá»…n ra</h5>
    <p><strong>Báº¯t Ä‘áº§u:</strong> {{ event.datetime_start|date:"d/m/Y (H:i)" }}</p>
    <p><strong>Káº¿t thÃºc:</strong> {{ event.datetime_end|date:"d/m/Y (H:i)" }}</p>
  </div>

  <!-- ğŸ“ Äá»ŠA ÄIá»‚M -->
  <div class="card shadow-sm border-0 p-4 mb-4 rounded-4">
    <h5 class="fw-bold mb-3 text-success">ğŸ“ Äá»‹a Ä‘iá»ƒm cá»¥ thá»ƒ</h5>
    <p>{{ event.address|default:"Äang cáº­p nháº­t" }}</p>
    {% if event.lat and event.lng %}
      <a href="https://www.google.com/maps?q={{ event.lat }},{{ event.lng }}" 
         target="_blank" class="btn btn-outline-success rounded-pill px-4">
        <i class="bi bi-map"></i> Má»Ÿ báº£n Ä‘á»“
      </a>
    {% endif %}
  </div>

  <!-- â˜ï¸ LIÃŠN Há»† -->
  <div class="card shadow-sm border-0 p-4 mb-4 rounded-4">
    <h5 class="fw-bold mb-3 text-success">ğŸ“ LiÃªn há»‡</h5>
    {% if event.contact_phone %}
      <a href="tel:{{ event.contact_phone }}" class="text-decoration-none text-success fs-5">{{ event.contact_phone }}</a>
    {% else %}
      <p>KhÃ´ng cÃ³ thÃ´ng tin liÃªn há»‡.</p>
    {% endif %}
  </div>

  <!-- âœ… NÃšT ÄÄ‚NG KÃ / Há»¦Y-checkin_via_otp -->
  <!-- âœ… NÃšT ÄÄ‚NG KÃ / Há»¦Y & CHECK-IN -->
<div class="text-center mt-4 mb-5">

  <!-- Form Ä‘Äƒng kÃ½ / há»§y -->
  <form method="POST" action="{% url 'toggle_event_registration' event.id %}" class="d-inline-block">
    {% csrf_token %}
    <button 
      type="submit"
      class="btn {% if is_registered %}btn-danger{% else %}btn-success{% endif %} px-5 py-3 fs-5 fw-semibold rounded-pill shadow-sm">
      {% if is_registered %}âŒ Há»§y Ä‘Äƒng kÃ½{% else %}âœ… ÄÄƒng kÃ½{% endif %}
    </button>
  </form>

  <!-- ğŸŸ¢ NÃºt Check-in: chá»‰ hiá»ƒn thá»‹ náº¿u Ä‘Ã£ Ä‘Äƒng kÃ½ vÃ  sá»± kiá»‡n Ä‘ang diá»…n ra -->
  {% if is_registered and event.status == "in_progress" %}
    {% if has_checked_in %}
      <button class="btn btn-secondary px-5 py-3 fs-5 fw-semibold rounded-pill shadow-sm ms-2" disabled>
        âœ… ÄÃ£ Ä‘iá»ƒm danh
      </button>
    {% else %}
      <a href="{% url 'checkin_via_otp' %}" 
         class="btn btn-outline-success px-5 py-3 fs-5 fw-semibold rounded-pill shadow-sm ms-2">
        ğŸ¯ Check-in sá»± kiá»‡n
      </a>
    {% endif %}
{% endif %}

</div>

<!-- ğŸ¨ CSS -->
<style>
  .btn-back {
    position: fixed;
    top: 90px;
    left: 25px;
    background-color: #1e5631;
    color: #fff;
    border-radius: 50px;
    padding: 10px 18px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.25);
    transition: 0.25s;
    text-decoration: none;
    z-index: 1000;
  }
  .btn-back:hover { background-color: #27ae60; transform: translateY(-2px); }
  .event-banner { width: 100%; max-height: 420px; object-fit: cover; border-radius: 16px; }
  .card { background: #f8fff5; }
</style>

<!-- ğŸ•’ Äá»“ng há»“ Ä‘áº¿m ngÆ°á»£c -->
{% if event.status == "upcoming" %}
<script>
  const startTime = new Date("{{ event.datetime_start|date:'Y-m-d H:i:s' }}").getTime();
  const countdownEl = document.getElementById("countdown");

  const countdown = setInterval(() => {
    const now = new Date().getTime();
    const distance = startTime - now;

    if (distance <= 0) {
      clearInterval(countdown);
      countdownEl.textContent = "ğŸŸ¢ Sá»± kiá»‡n Ä‘ang diá»…n ra!";
      return;
    }

    const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    const s = Math.floor((distance % (1000 * 60)) / 1000);
    countdownEl.textContent = `â³ Báº¯t Ä‘áº§u sau: ${h}h ${m}m ${s}s`;
  }, 1000);
</script>
{% endif %}
{% endblock main-content %}
