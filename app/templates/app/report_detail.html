{% extends "app/base.html" %}
{% load static %}

{% block main-content %}
<div class="container py-4" style="max-width: 800px;">

    <!-- ===== TI√äU ƒê·ªÄ ===== -->
    <div class="mb-4">
        <h2 class="fw-bold text-success">
            üìÑ Chi ti·∫øt b√°o c√°o ƒëi·ªÉm r√°c
        </h2>
        <p class="text-muted mb-0">
            G·ª≠i b·ªüi <strong>{{ report.user.username }}</strong>
            ‚Ä¢ {{ report.created_at|date:"d/m/Y H:i" }}
        </p>
    </div>

    <!-- ===== TR·∫†NG TH√ÅI ===== -->
    <div class="alert
        {% if report.admin_status == 'approved' %}
            alert-success
        {% elif report.admin_status == 'rejected' %}
            alert-danger
        {% else %}
            alert-warning
        {% endif %}
    ">
        <strong>Tr·∫°ng th√°i:</strong>
        {{ report.get_admin_status_display }}
        {% if report.verified_at %}
            ‚Ä¢ Duy·ªát l√∫c {{ report.verified_at|date:"d/m/Y H:i" }}
        {% endif %}
    </div>

    <!-- ===== ·∫¢NH ===== -->
    {% if report.images %}
    <div class="card mb-4">
        <div class="card-header fw-semibold">
            üì∏ H√¨nh ·∫£nh ƒëi·ªÉm r√°c
        </div>
        <div class="card-body text-center">
            <img
                src="{{ report.images.url }}"
                class="img-fluid rounded"
                style="max-height: 420px;"
            >
        </div>
    </div>
    {% endif %}

    <!-- ===== M√î T·∫¢ ===== -->
    {% if report.description %}
    <div class="card mb-4">
        <div class="card-header fw-semibold">
            üìù M√¥ t·∫£ c·ªßa ng∆∞·ªùi b√°o c√°o
        </div>
        <div class="card-body">
            {{ report.description|linebreaks }}
        </div>
    </div>
    {% endif %}

    <!-- ===== V·ªä TR√ç ===== -->
    <div class="card mb-4">
        <div class="card-header fw-semibold">
            üìç V·ªã tr√≠ ƒëi·ªÉm r√°c
        </div>
        <div class="card-body">
            {% if report.lat and report.lng %}
                <p class="mb-2">
                    T·ªça ƒë·ªô:
                    <strong>{{ report.lat }}, {{ report.lng }}</strong>
                </p>
                {% if report.address %}
                    <p class="text-muted mb-2">
                        {{ report.address }}
                    </p>
                {% endif %}

                <div
                    id="map"
                    style="height:300px; border-radius:10px;"
                    class="border"
                ></div>
            {% else %}
                <p class="text-muted mb-0">
                    Kh√¥ng c√≥ d·ªØ li·ªáu v·ªã tr√≠.
                </p>
            {% endif %}
        </div>
    </div>

    <!-- ===== K·∫æT QU·∫¢ AI ===== -->
    <div class="card mb-4">
        <div class="card-header fw-semibold">
            ü§ñ Ph√¢n t√≠ch AI
        </div>
        <div class="card-body">
            {% if report.analysis_summary %}
                <p>{{ report.analysis_summary }}</p>

                <ul class="mb-0">
                    {% if report.predicted_trash_type %}
                    <li>
                        <strong>Lo·∫°i r√°c ch√≠nh:</strong>
                        {{ report.get_predicted_trash_type_display }}
                    </li>
                    {% endif %}
                    <li>
                        <strong>Kh·ªëi l∆∞·ª£ng ∆∞·ªõc t√≠nh:</strong>
                        {{ report.estimated_weight_ton }} t·∫•n
                    </li>
                    <li>
                        <strong>Nh√¢n l·ª±c ƒë·ªÅ xu·∫•t:</strong>
                        {{ report.recommended_volunteers }} ng∆∞·ªùi
                    </li>
                </ul>
            {% else %}
                <p class="text-muted mb-0">
                    AI ch∆∞a ph√¢n t√≠ch ƒë∆∞·ª£c d·ªØ li·ªáu.
                </p>
            {% endif %}
        </div>
    </div>

    <!-- ===== H√ÄNH ƒê·ªòNG ADMIN ===== -->
    {% if user.is_staff %}
    <div class="d-flex gap-2">
        {% if report.admin_status != 'approved' %}
        <a
            href="{% url 'admin_verify_report' report.id %}"
            class="btn btn-success"
            onclick="return confirm('X√°c nh·∫≠n duy·ªát b√°o c√°o n√†y?')"
        >
            ‚úî Duy·ªát b√°o c√°o
        </a>
        {% endif %}

        <a href="{% url 'admin_report_list' %}" class="btn btn-secondary">
            ‚Üê Quay l·∫°i danh s√°ch
        </a>
    </div>
    {% else %}
    <a href="{% url 'home' %}" class="btn btn-secondary">
        ‚Üê Quay l·∫°i
    </a>
    {% endif %}

</div>

<!-- ===== GOOGLE MAP ===== -->
{% if report.lat and report.lng %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAP_API_KEY }}"></script>
<script>
    function initMap() {
        const position = {
            lat: {{ report.lat }},
            lng: {{ report.lng }},
        };

        const map = new google.maps.Map(document.getElementById("map"), {
            center: position,
            zoom: 15,
        });

        new google.maps.Marker({
            position: position,
            map: map,
        });
    }

    window.addEventListener("load", initMap);
</script>
{% endif %}
{% endblock %}
